<% title = @post.title %>
<% link = @post.link %>
<% provide(:title, title) %>

<div class="post">
  <% path = post_path(@post) %>
  <section class="votable-row">
    <%= render partial: 'shared/vote_controls',
               locals: { controls: voting_controls_for(@post) } %>
    <hgroup class="votable">
      <%= render partial: 'shared/metadata',
                locals: { resource: @post, path: path } %>
      <%= tag.h1(class: 'post-title') { link.blank? ? title : tag.a(title, href: link) } %>
    </hgroup>
  </section>
  <% if @post.body %>
    <div class="post-body">
    <% @post.body.lines.map(&:chomp).each do |paragraph| %>
      <%= tag.p(paragraph) %>
    <% end %>
    </div>
  <% end %>
  <% if @post.user == current_user %>
    <div class="post-actions">
      <div><%= link_to 'Edit', edit_post_path(@post) %></div>
      <%= render partial: 'shared/actions', locals: { resource: @post } %>
    </div>
  <% end %>
</div>

<div>
  <% if user_is_logged_in? %>
    <%= render partial: 'comments/form' %>
  <% else %>
  <div class="members-only">
    <span>Log in or sign up to leave a comment</span>
    <ul class="nav">
      <%= render partial: 'shared/login_signup' %>
    </ul>
  </div>
  <% end %>
</div>

<div class="comments">
  <% @comments.each do |comment| %>
    <section class="comment-row votable-row">
      <% if (level = (ancestor = comment).level) > 0 %>
        <div class="reverse-thread-area">
          <% level.times do %>
            <% ancestor = ancestor.parent %>
            <div class="with-comment-<%= ancestor.id %> threadline-space">
              <div class="threadline"></div>
            </div>
          <% end %>
        </div>
      <% end %>
      <%= render partial: 'shared/vote_controls',
                locals: { controls: voting_controls_for(comment) } %>
      <div class="comment with-comment-<%= comment.id %>" id="<%= comment.id %>">
        <%= render partial: 'shared/metadata',
                  locals: { resource: comment, path: path } %>
        <p class="comment-text"><%= comment.text || 'deleted' %></p>
      </div>
      <% if current_user == comment.user %>
        <div class="comment-actions">
          <%= render partial: 'shared/actions', locals: { resource: comment } %>
        </div>
      <% end %>
    </section>
  <% end %>
</div>
